---
title: "Using Simphony to Benchmark Rhythmic Detection Methods"
author: "Jordan Singer"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Vignette Title}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, message = FALSE}
library(ggplot2)
library(knitr)
library(limma)
library(precrec)
library(simphony)
```

```{r, message = FALSE}
exprGroupsList = list(data.table::data.table(geneFrac = c(0.5, 0.5),
                                             base = 0,
                                             amp = c(0, 1),
                                             phase = 0))
simGse = simulateGeneData(exprGroupsList, nGenes = 1000)
kable(exprGroupsList[[1]])
```

```{r, message = FALSE}
sm = data.table::data.table(simGse$sm)
sm[, time_cos := cos(time * 2*pi / 24)]
sm[, time_sin := sin(time * 2*pi / 24)]
emat = simGse$emat
design = model.matrix(~ time_cos + time_sin, data = sm)
fit = lmFit(emat, design)
fit = eBayes(fit, trend = TRUE)

gm = data.table::data.table(simGse$gm)
drLimma = topTable(fit, coef = 2:3, number = Inf)
drLimma$gene = rownames(drLimma)
gm = merge(gm, drLimma)
```

```{r, message = FALSE}
rocprc = evalmod(scores = -log10(gm$P.Value), labels = ifelse(gm$group == 1, FALSE, TRUE))
autoplot(rocprc)
```

```{r, message = FALSE}
ggplot(gm, aes(x = factor(ifelse(group == 1, 'Non Rhythmic', 'Rhythmic')), y = P.Value)) +
  geom_violin() +
  labs(x = NULL, y = expression(p[rhy]), title = 'limma p-values of rhythmicity')
```

```{r, message = FALSE}
nonRhythmicGene = simGse$gm$gene[simGse$gm$group == 1][1]
rhythmicGene = simGse$gm$gene[simGse$gm$group == 2][1]
combinedExpr = data.table::data.table(expression = c(simGse$emat[nonRhythmicGene,], simGse$emat[rhythmicGene,]),
                                      time = sm$time,
                                      cond = c(rep('nonRhythmic', ncol(simGse$emat)), rep('rhythmic', ncol(simGse$emat))))

ggplot(combinedExpr, aes(x = time, y = expression, color = cond)) +
  geom_point() +
  labs(x = 'time (h)', y = 'expression', title = 'Sample simulated time courses', color = 'rhythmic condition')
```